name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Verify Swift toolchain
        run: |
          swift --version
          xcodebuild -version

      - name: Build universal binary
        run: make build

      - name: Verify binary architecture
        run: |
          file bin/inotes
          lipo -info bin/inotes

      - name: Package binary
        id: package
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TARBALL="inotes-${VERSION}-universal-apple-darwin.tar.gz"
          tar czf "$TARBALL" -C bin inotes
          
          # Calculate SHA256
          SHA256=$(shasum -a 256 "$TARBALL" | awk '{print $1}')
          
          echo "tarball=$TARBALL" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Package: $TARBALL"
          echo "ðŸ”’ SHA256: $SHA256"
          ls -lh "$TARBALL"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          SHA256=${{ steps.package.outputs.sha256 }}
          TARBALL=${{ steps.package.outputs.tarball }}
          
          cat > release_notes.md << EOF
          ## Installation

          ### Via Homebrew
          \`\`\`bash
          brew install wangwalk/tap/inotes
          \`\`\`

          ### Manual Download
          Download the universal binary (supports both Apple Silicon and Intel):

          \`\`\`bash
          curl -LO https://github.com/wangwalk/inotes/releases/download/v${VERSION}/${TARBALL}
          tar xzf ${TARBALL}
          sudo cp inotes /usr/local/bin/
          sudo chmod +x /usr/local/bin/inotes
          \`\`\`

          ### Verify Installation
          \`\`\`bash
          inotes --version  # Should show: ${VERSION}
          shasum -a 256 ${TARBALL}
          # Expected: ${SHA256}
          \`\`\`

          ## Requirements
          - macOS 14+ (Sonoma or later)
          - Automation permission for Notes.app

          ## Changes
          See [CHANGELOG.md](https://github.com/wangwalk/inotes/blob/main/CHANGELOG.md) for details.
          EOF
          
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.tarball }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… Release created successfully!"
          echo ""
          echo "ðŸ“¦ Package: ${{ steps.package.outputs.tarball }}"
          echo "ðŸ”’ SHA256: ${{ steps.package.outputs.sha256 }}"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo ""
          echo "ðŸ“ Next step: Update Homebrew Formula"
          echo "   Visit: https://github.com/wangwalk/homebrew-tap"
          echo "   SHA256: ${{ steps.package.outputs.sha256 }}"

  update-homebrew:
    needs: build-and-release
    runs-on: ubuntu-latest
    # åªæœ‰é…ç½®äº† HOMEBREW_TAP_TOKEN æ‰è¿è¡Œ
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && secrets.HOMEBREW_TAP_TOKEN != ''
    steps:
      - name: Extract version and metadata
        id: meta
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Download the release to get SHA256
          TARBALL="inotes-${VERSION}-universal-apple-darwin.tar.gz"
          curl -sL "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${TARBALL}" -o "$TARBALL"
          SHA256=$(sha256sum "$TARBALL" | awk '{print $1}')
          
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "SHA256: $SHA256"

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: wangwalk/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN || secrets.GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update Formula
        working-directory: homebrew-tap
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          SHA256=${{ steps.meta.outputs.sha256 }}
          
          cat > Formula/inotes.rb << 'EOF'
          class Inotes < Formula
            desc "Manage Apple Notes from the terminal"
            homepage "https://github.com/wangwalk/inotes"
            version "$VERSION"
            license "MIT"

            on_macos do
              url "https://github.com/wangwalk/inotes/releases/download/v$VERSION/inotes-$VERSION-universal-apple-darwin.tar.gz"
              sha256 "$SHA256"
            end

            depends_on :macos
            depends_on macos: :sonoma

            def install
              bin.install "inotes"
            end

            test do
              assert_match "#{version}", shell_output("#{bin}/inotes --version").strip
            end
          end
          EOF
          
          # Replace placeholders
          sed -i "s/\$VERSION/$VERSION/g" Formula/inotes.rb
          sed -i "s/\$SHA256/$SHA256/g" Formula/inotes.rb
          
          echo "âœ… Formula updated:"
          cat Formula/inotes.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN || secrets.GITHUB_TOKEN }}
          path: homebrew-tap
          commit-message: "feat: update inotes to v${{ steps.meta.outputs.version }}"
          branch: update-inotes-${{ steps.meta.outputs.version }}
          delete-branch: true
          title: "Update inotes to v${{ steps.meta.outputs.version }}"
          body: |
            ## ðŸš€ Automated Formula Update
            
            This PR updates the inotes formula to version **v${{ steps.meta.outputs.version }}**.
            
            ### Changes
            - Version: `${{ steps.meta.outputs.version }}`
            - SHA256: `${{ steps.meta.outputs.sha256 }}`
            - Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.meta.outputs.version }}
            
            ### Checklist
            - [x] Formula updated with new version
            - [x] SHA256 checksum updated
            - [x] Download URL updated
            - [ ] Manual testing (run after merge):
              ```bash
              brew uninstall wangwalk/tap/inotes
              brew install wangwalk/tap/inotes
              inotes --version  # Should show: ${{ steps.meta.outputs.version }}
              ```
            
            ---
            ðŸ¤– This PR was automatically generated by the [release workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
